# ДЗ 3

## Подготовка к выполнению работы
В качестве основной сущности приложения был выбран плейлист, так как он имеет Endpoint`ы на GET и POST запросы, а также реализует одну из ключевых задач приложения - социальное взаимодействие в рамках музыкального сервиса. 

В качестве инструмента был выбран [wrk](https://github.com/wg/wrk).

Параметры запроса описываются в lua скриптах, а непосредственно нагрузочное тестирование и передача jwt-токена для прохождения проверки авторизованности в sh скриптах. В скрите для GET-запроса также передается id пользователя.

При проведении wrk тестирования можно настроить следующие параметры:
```
-c, --connections: total number of HTTP connections to keep open with
                   each thread handling N = connections/threads

-d, --duration:    duration of the test

-t, --threads:     total number of threads to use

-s, --script:      LuaJIT script

-H, --header:      HTTP header to add to request, e.g. "User-Agent: wrk"

    --latency:     print detailed latency statistics

    --timeout:     record a timeout if a response is not received within
                   this amount of time.
```

Для обеспечения достаточной нагрузки выбраны значения ```connections=150, threads=100```.
При этом каждый поток закрывается после выполнения 1000 запросов, 
чтобы гарантировать заполнение 100_000 плейлистами.

Для более равномерного заполнения БД устанавливаем ```duration=1800s```.

При получении плейстов ```duration=900s```, тк эта операция более простая.

Количество запросов ограничено, а промежуток времени выбирается достаточно большой,
что необходимо учитывать при анализе RPC, поскольку он может иметь значение ниже ожидаемого.

## Процесс выполнения работы

### Нагрузочное тестирование API Endpoint`а, создающего основную сущность

Запускаем скрипт [post_wrk_test.sh](https://github.com/go-park-mail-ru/2024_2_NovaCode/blob/db_3/internal/db/postgres/perf_test/post_wrk_test.sh)

Документация полученных результатов
```
```

### Нагрузочное тестирование API Endpoint`а, создающего основную сущность

Запускаем скрипт [get_wrk_test.sh](https://github.com/go-park-mail-ru/2024_2_NovaCode/blob/db_3/internal/db/postgres/perf_test/get_wrk_test.sh)

Документация полученных результатов
```
```

### Анализ полученных результатов

Выходные результаты отражают:
- количество запущенных потоков и соединений
```
_ threads and _ connections
```

- Latency (Время отклика) и Req/Sec (Количество запросов) в секунду, отражающие параметры функции Гаусса,
где Avg - среднее, Sydev - стандартное отклонение, Max - максимальное, +/- Stdev -  процент запросов в пределах стандартного отклоения
```
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency        _ms       _ms      _ms     _%
Req/Sec        _         _        _       _%
```

- количество переданных запросов за промежуток времени, переданные данные, пропускная способность
```
_ requests in _s, _MB read
Requests/sec:   _
Transfer/sec:   _KB
```
#### Выходные результаты после выполения ```POST``` запроса 

- Средняя задержка:
- RPS:

что соответсвует допустимым значениям в рамках работы приложения

#### Выходные результаты после выполения ```GET``` запроса 

- Средняя задержка:
- RPS:

что соответсвует допустимым значениям в рамках работы приложения


### Оптимизация
Чтобы понять, как можно улучшить время получения плейлистов пользователя, можно проанализировать план выполнения запроса
```
SELECT id, name, image, owner_id, is_private, created_at, updated_at FROM playlist WHERE owner_id = $1 ORDER BY created_at DESC
```
с помощью ```EXPLAIN ANALYZE```.

Улучшение, которое можно внести, это добавление индекса на owner_id.

Сейчас фильтрация по owner_id выполняется в помошью sequential scan, то есть прохождением по всей таблице.

Этот запрос не сложный, но поскольку плейлисты являются основной сущностью приложения и запросы на их получение
выполняются часто, есть смысл добавить индекс, чтобы фильтрацию происходила с использованием index scan.

Также были добавлены другие индексы на основные сущности playlist и track [create_indexes] ()

- Результаты тестирования после добавления индекса
```
```

- Анализ полученных результатов после добавления индекса.

Запросы стали выполняться быстрее, что соответсвует ожиданиям.
