# ДЗ 3

## Подготовка к выполнению работы
В качестве основной сущности приложения был выбран плейлист, так как он имеет Endpoint`ы на GET и POST запросы, а также реализует одну из ключевых задач приложения - социальное взаимодействие в рамках музыкального сервиса. 

В качестве инструмента был выбран [wrk](https://github.com/wg/wrk).

Параметры запроса описываются в lua скриптах, а непосредственно нагрузочное тестирование и передача jwt-токена для прохождения проверки авторизованности в sh скриптах. В скрите для GET-запроса также передается id пользователя.

При проведении wrk тестирования можно настроить следующие параметры:
```
-c, --connections: total number of HTTP connections to keep open with
                   each thread handling N = connections/threads

-d, --duration:    duration of the test

-t, --threads:     total number of threads to use

-s, --script:      LuaJIT script

-H, --header:      HTTP header to add to request, e.g. "User-Agent: wrk"

    --latency:     print detailed latency statistics

    --timeout:     record a timeout if a response is not received within
                   this amount of time.
```

Для обеспечения достаточной нагрузки выбраны значения ```connections=150, threads=100```.
При этом каждый поток закрывается после выполнения 1000 запросов, 
чтобы гарантировать заполнение 100_000 плейлистами.

Для заполнения БД устанавливаем ```duration=3000s```.

При получении плейстов ```duration=1200s```.

Количество запросов ограничено, а промежуток времени выбирается достаточно большой,
что необходимо учитывать при анализе RPC, поскольку он может иметь значение ниже ожидаемого.

## Процесс выполнения работы

### Нагрузочное тестирование API Endpoint`а, создающего основную сущность

Запускаем скрипт [post_wrk_test.sh](https://github.com/go-park-mail-ru/2024_2_NovaCode/blob/db_3/internal/db/postgres/perf_test/post_wrk_test.sh)

Документация полученных результатов
```
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   369  100   324  100    45   1775    246 --:--:-- --:--:-- --:--:--  2027
Running 50m test @ https://nova-music.ru/api/v1/playlists
  100 threads and 150 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   282.79ms   79.88ms   1.99s    91.00%
    Req/Sec     3.55      1.24    60.00     57.42%
  100000 requests in 50.00m, 47.70MB read
  Socket errors: connect 0, read 0, write 0, timeout 28
  Non-2xx or 3xx responses: 99900
Requests/sec:     33.33
Transfer/sec:     16.28KB
```

### Нагрузочное тестирование API Endpoint`а, читающего основную сущность

Запускаем скрипт [get_wrk_test.sh](https://github.com/go-park-mail-ru/2024_2_NovaCode/blob/db_3/internal/db/postgres/perf_test/get_wrk_test.sh)

Документация полученных результатов
```
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   369  100   324  100    45   1716    238 --:--:-- --:--:-- --:--:--  1962
Running 20m test @ https://nova-music.ru/api/v1/playlists/a4bd6342-f456-4271-878d-c87aea000c99/allPlaylists
  100 threads and 150 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   454.03ms  183.51ms   2.00s    90.84%
    Req/Sec     2.02      0.88    20.00     60.80%
  264310 requests in 20.00m, 2.68GB read
  Socket errors: connect 0, read 0, write 0, timeout 385
  Non-2xx or 3xx responses: 1
Requests/sec:    220.24
Transfer/sec:      2.29MB
```

### Анализ полученных результатов

Выходные результаты отражают:
- количество запущенных потоков и соединений
```
_ threads and _ connections
```

- Latency (Время отклика) и Req/Sec (Количество запросов) в секунду, отражающие параметры функции Гаусса,
где Avg - среднее, Sydev - стандартное отклонение, Max - максимальное, +/- Stdev -  процент запросов в пределах стандартного отклоения
```
Thread Stats   Avg      Stdev     Max   +/- Stdev
Latency        _ms       _ms      _ms     _%
Req/Sec        _         _        _       _%
```

- количество переданных запросов за промежуток времени, переданные данные, пропускная способность
```
_ requests in _s, _MB read
Requests/sec:   _
Transfer/sec:   _KB
```
#### Выходные результаты после выполения ```POST``` запроса 

- Средняя задержка: 282.79ms
- RPS: 33.33

Средняя задержка соответсвует допустимым значениям в рамках работы приложения.
В данном случае значение RPS низкое, 
так как для заполнения данных был выбран довольно большой промещуток времени
при фиксированном количестве запросов 100_000.
То есть при заполнении БД в целом нагрузка была небольшой.

#### Выходные результаты после выполения ```GET``` запроса 

- Средняя задержка: 454.03ms
- RPS: 220.24

Средняя задержка соответсвует допустимым значениям в рамках работы приложения.
Значение RPS удовлетворяет требованиям производительности.


### Оптимизация
Чтобы понять, как можно улучшить время получения плейлистов пользователя, можно проанализировать план выполнения запроса
```
SELECT id, name, image, owner_id, is_private, created_at, updated_at FROM playlist WHERE owner_id = $1 ORDER BY created_at DESC
```
с помощью ```EXPLAIN ANALYZE```.

Улучшение, которое можно внести, это добавление индекса на owner_id.

Сейчас фильтрация по owner_id выполняется в помошью sequential scan, то есть прохождением по всей таблице.

Этот запрос не сложный, но поскольку плейлисты являются основной сущностью приложения и запросы на их получение
выполняются часто, есть смысл добавить индекс, чтобы фильтрацию происходила с использованием index scan или bitmap index scan.

Также были добавлены другие индексы на основные сущности playlist и track [create_indexes] (https://github.com/go-park-mail-ru/2024_2_NovaCode/blob/db_3/internal/db/postgres/migrations/20241218222415_create_indexes.sql)

#### Результаты тестирования после добавления индекса
```
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   369  100   324  100    45   1093    151 --:--:-- --:--:-- --:--:--  1246
Running 20m test @ https://nova-music.ru/api/v1/playlists/a4bd6342-f456-4271-878d-c87aea000c99/allPlaylists
  100 threads and 150 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   425.59ms  180.15ms   2.00s    91.20%
    Req/Sec     2.21      0.91    10.00     83.11%
  282875 requests in 20.00m, 2.87GB read
  Socket errors: connect 0, read 0, write 0, timeout 345
Requests/sec:    235.71
Transfer/sec:      2.45MB
```

#### Анализ полученных результатов после добавления индекса.

- Средняя задержка: 454.03ms -> 425.59ms
- RPS: 220.24 -> 235.71

Показатели улучшились незначительно, но в данном случае необходимо учитывать, 
что запрос искусственный, поскольку при поиске плейлистов по пользователю фактически выбираются все
(т.к. 100_000 генерировались от одного пользователя), а значит в этом случае индекс будет неселективен.

Но даже с этим учетом, прирост производительности все же наблюдается.

#### Дополнительные предложения по оптимизации.
1. Денормализация базы данных,
например,
- в таблице треков хранить имя артиста и альбома,
- хранить в плейлистах, альбомах и артистах количество треков,а в артистах - количество альбомов,
- хранить в плейлистах, альбомах общую продолжительность треков,
- хранить в таблице ползователя количество любимых плейлистов, артистов, альбомов и треков.

2. В перспективе при большом количестве данных: партиционирование таблиц.
Например, плейлисты можно партиционировать по времени, тк более актуальные будут чаще исползоваться.

Дальнейшие меры по оптимизации должны производится по необходимости, если в ходе профилирования обнаруживается просадка производительности на запросах.
Так, на данном этапе проводить денормализацию и партиционирование не имеет смысла, тк была продемонстрирова высокая производельность, а их внедрение нарушает целостность данных.
